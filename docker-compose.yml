version: '3.4'

volumes:
  # the same volume is used for apiserver and validator
  # as apiserver needs the anouncement file generated by the validator
  # we first start validator then the apiserver
  validator_data:

services:
  apiserver:
    depends_on:
      validator:
        condition: service_completed_successfully
    build:
      context: ./hyperlane-monorepo/rust
      dockerfile: Dockerfile
    volumes:
      - "validator_data:/data"
      - "$CONFIG_FILES:/agent-config.json"
    ports:
      - "$API_PORT:8080"
    command: >
      /app/apiserver 
      --db /data/db
      --relayChains $RELAY_CHAINS
      --originChainName $ORIGIN_CHAIN
      --checkpointSyncer.type localStorage
      --checkpointSyncer.path /data/signatures
      --validator.key $PRIV_KEY
    environment:
      - CONFIG_FILES=/agent-config.json

  validator:
    build:
      context: ./hyperlane-monorepo/rust
      dockerfile: Dockerfile
    volumes:
      - "validator_data:/data"
      - "$CONFIG_FILES:/agent-config.json"
    command: >
      /app/validator 
      --db /data/db
      --originChainName $ORIGIN_CHAIN
      --checkpointSyncer.type localStorage
      --checkpointSyncer.path /data/signatures
      --validator.key $PRIV_KEY
    environment:
      - CONFIG_FILES=/agent-config.json