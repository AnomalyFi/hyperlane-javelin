version: '3.4'

volumes:
  # the same volume is used for apiserver and validator
  # as apiserver needs the anouncement file generated by the validator
  # we first start validator then the apiserver
  validator_data:

services:
  # build-agents:
  #   image: hyperlane-agents
  #   build:
  #     context: ./hyperlane-monorepo/rust
  #     dockerfile: Dockerfile
  #   command: ['echo', 'build completed']

  apiserver:
    image: hyperlane-javelin
    depends_on:
      # build-agents:
      #   condition: service_completed_successfully
      validator:
        condition: service_completed_successfully
    volumes:
      - "validator_data:/data"
      - "$CONFIG_FILES:/agent-config.json"
    ports:
      - "$API_PORT:8080"
    command: >
      /app/apiserver 
      --db /data/db
      --relayChains $RELAY_CHAINS
      --originChainName $ORIGIN_CHAIN
      --checkpointSyncer.type localStorage
      --checkpointSyncer.path /data/signatures
      --validator.key $PRIV_KEY
    environment:
      - CONFIG_FILES=/agent-config.json

  validator:
    image: hyperlane-javelin
    # depends_on:
    #   - build-agents
    volumes:
      - "validator_data:/data"
      - "$CONFIG_FILES:/agent-config.json"
    command: >
      /app/validator 
      --db /data/db
      --originChainName $ORIGIN_CHAIN
      --checkpointSyncer.type localStorage
      --checkpointSyncer.path /data/signatures
      --validator.key $PRIV_KEY
    environment:
      - CONFIG_FILES=/agent-config.json
